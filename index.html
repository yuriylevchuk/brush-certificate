<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <title>Сертификаты BRUSH.GURU</title>
	<link rel="stylesheet" href="static/css/jquery-ui.min.css">
  <link rel="stylesheet" href="static/css/style.css">
</head>
<body id="body" class="certificate__page certificate__page_theme_dark js-certificate__page">
  <div class="certificate__container">
  	<header class="certificate__header">
			<fieldset class="certificate__fieldset certificate__fieldset_type_name">
				<label for="name-input">ФИО (полностью)</label>
				<input type="text" id="name-input" class="certificate__input js-certificate__input" placeholder="Спирин Константин Александрович">
			</fieldset>
			<fieldset class="certificate__fieldset certificate__fieldset_type_number">
				<label for="number-input">Номер сертификата</label>
				<input type="text" id="number-input" class="certificate__input js-certificate__input" placeholder="B00000000">
			</fieldset>
			<fieldset class="certificate__fieldset certificate__fieldset_type_lang">
				<label class="certificate__label">Rus <input type="radio" class="certificate__radiobutton" name="certificate-lang" value="ru" checked></label>
				<hr>
				<label class="certificate__label">Eng <input type="radio" class="certificate__radiobutton" name="certificate-lang" value="en"></label>
			</fieldset>
			<fieldset class="certificate__fieldset certificate__fieldset_type_format">
				<label class="certificate__label">A4 <input type="radio" class="certificate__radiobutton" name="certificate-format" value="a4" checked></label>
				<hr>
				<label class="certificate__label">A5 <input type="radio" class="certificate__radiobutton" name="certificate-format" value="a5"></label>
			</fieldset>
			<div class="certificate__button-group">
				<div>
					<button type="button" id="check-button" class="certificate__button" disabled>Проверить</button>
					<a type="button" class="certificate__link js-download-link" download="certificate.jpg">Скачать (.jpg)</a>
				</div>
			</div>
		</header>
	
		<div class="certificate__wrapper">
			<img id="output-image" src="static/img/certificate.png" alt="">
		</div>
	</div>	
	<main id="certificate" class="certificate__main js-certificate__main">
		<h1 class="text text_font_marvin certificate__title js-lang-switched" 
				data-text-ru="Сертификат" 
				data-text-en="Certificate">Сертификат</h1>
		<p class="text text_color_primary certificate__number js-certificate__number">B01100013</p>
		<p class="text text_align_center text_color_secondary js-lang-switched" 
			 data-text-ru="Настоящий сертификат подтверждает, что"
			 data-text-en="This certificate confirms that">Настоящий сертификат подтверждает, что</p>
		<p class="text text_align_center text_color_primary text_font_marvin text_size_big js-certificate__student-name">Спирин Константин Александрович</p>
		<p class="text text_align_center text_color_secondary js-lang-switched" 
			 data-text-ru="успешно завершил(а) обучение на курсе"
			 data-text-en="Successfully completed training on the course">успешно завершил(а) обучение на курсе</p>
		<p class="text text_align_center text_color_primary text_font_marvin text_size_middle js-certificate__course-name">Иллюстратор.ядро</p>
		<p class="text text_align_center text_color_secondary certificate__caption_3 js-lang-switched" 
			 data-text-ru="выполнил(а) итоговую работу и получил(а) навыки в&nbsp;соответствии с программой курса."
			 data-text-en="Completed the final work and received skills in&nbsp;accordance with the course program.">выполнил(а) итоговую работу и получил(а) навыки в&nbsp;соответствии с программой курса.</p>
		<div class="certificate__group">
			<div>
				<p class="text text_no-margin text_weight_bold"><span class="js-lang-switched" data-text-ru="Теория" data-text-en="Theory">Теория</span>: <span class="text_color_primary"><span class="js-certificate__theory-hours">12</span> <span class="js-lang-switched" data-text-ru="часов" data-text-en="hours">часов</span>.</span></p>
				<p class="text text_weight_bold"><span class="js-lang-switched" data-text-ru="Практика" data-text-en="Practice">Практика</span>: <span class="text_color_primary"><span class="js-certificate__practice-hours">40</span> <span class="js-lang-switched" data-text-ru="часов" data-text-en="hours">часов</span>.</span></p>
				<p class="text text_no-margin text_weight_bold"><span class="js-lang-switched" data-text-ru="Дата выдачи" data-text-en="Date of issue">Дата выдачи</span>: <span class="text_color_primary js-certificate__date">06/01/20</span></p>
			</div>
			<p class="text certificate__director js-lang-switched" data-text-ru="Директор: Спирин К. А." data-text-en="Director: Spirin K.A.">Директор: Спирин К. А.</p>
		</div>
		<p class="text text_align_center certificate__domain">brush.guru</p>
		<p class="text text_size_small text_align_center js-lang-switched" 
			 data-text-ru="Подлинность данного сертификата гарантирует уникальный регистрационный номер, проверить который можно направив запрос на почту: info@brush.guru"
			 data-text-en="The authenticity of this certificate is guaranteed by a unique registration number, which can be verified by sending a request by mail: info@brush.guru">
			 Подлинность данного сертификата гарантирует уникальный регистрационный номер, проверить который можно направив запрос на почту: info@brush.guru
		</p>
	</main>
	<script src="static/js/jquery-3.4.1.min.js"></script>	
	<script src="static/js/jquery-ui.min.js"></script>	
	<script src="static/js/html2canvas.min.js"></script>
  <script>
		window.STATE = {
			currentLanguage: 'ru',
			currentFormat: 'a4',
			currentThemeClass: 'certificate__page_theme_dark', 
		};

		$( document ).ready(function() {
			// FIXED ARRAY INDICES
			var I_CERT_NUM = 0,
					I_NAME_RU = 1,
					I_NAME_EN = 2,
					I_COURSE_RU = 3,
					I_COURSE_EN = 4,
					I_THEORY_H = 5,
					I_PRAC_H = 6,
					I_DATE = 7,
					I_THEME = 8;

			// FIXED THEME VALUE
			var THEME_DARK = 'dark',
					THEME_LIGHT = 'light';		

			function generateCanvas() {
				html2canvas(document.getElementById('certificate'), { scale: 1, logging: true, allowTaint: true, useCORS: false, }).then(function(canvas) {
					$('.js-download-link').attr('href', canvas.toDataURL('image/jpeg', 1.0).replace('image/jpeg', 'image/octet-stream'));
					$('#output-image').attr('src', canvas.toDataURL());
				});
			}

			$('.certificate__radiobutton[name="certificate-lang"]').on('change', function() {
				$('.js-download-link').removeAttr('href');
				if ($(this).prop('checked')) {
					window.STATE.currentLanguage = $(this).val();
				}
			});

			$('.certificate__radiobutton[name="certificate-format"]').on('change', function() {
				$('.js-download-link').removeAttr('href');
				if ($(this).prop('checked')) {
					window.STATE.currentFormat = $(this).val();
				}
			});

			var studentNames = [];
			var certificateNumbers = [];
			$.ajax({
				url: 'https://script.google.com/macros/s/AKfycbxIGY-rBhfOpSjfhjfzhozRyJoyuagq-yskuLwd/exec',
				type: 'GET',
				dataType: 'json',
				success: function(data) {
					for (var i = 0; i < data.result.length; i++) {
						studentNames.push(data.result[i][I_NAME_RU]);
						certificateNumbers.push(data.result[i][I_CERT_NUM]);
					}

					$('#name-input').autocomplete({
						source: function(request, response) {
							var results = $.ui.autocomplete.filter(studentNames, request.term);
							response(results.slice(0, 5));
						},
						minLength: 3,
					});

					$('#number-input').autocomplete({
						source: function(request, response) {
							var results = $.ui.autocomplete.filter(certificateNumbers, request.term);
							response(results.slice(0, 5));
						},
						minLength: 3,
					});

					$('#check-button').removeAttr('disabled');

					$('#check-button').on('click', function() {
						var newIndex = -1;
						var newStudentName = $('#name-input').val().trim();
						var newCertificateNumber = $('#number-input').val().trim();
						if (newStudentName) {
							newIndex = studentNames.findIndex(function(el) {
								if (el.indexOf(newStudentName) >= 0) {
									return true;
								}
								return false;
							});
						}

						if (newIndex < 0) {
							if (newCertificateNumber) {
								newIndex = certificateNumbers.findIndex(function(el) {
									if (el.indexOf(newCertificateNumber) >= 0) {
										return true;
									}
									return false;
								});
							}							
						}

						if (newIndex >= 0) {
							$('#name-input').val(data.result[newIndex][I_NAME_RU]);
							$('#number-input').val(data.result[newIndex][I_CERT_NUM]);
							
							$('.js-lang-switched').each(function(i, el) {
								$(el).text($(el).data('text-' + window.STATE.currentLanguage));
							});

							if (window.STATE.currentFormat == 'a5') {
								$('.js-certificate__main').addClass('certificate__main_format_a5');
							} else {
								$('.js-certificate__main').removeClass('certificate__main_format_a5');
							}

							$('.js-certificate__number').text(data.result[newIndex][I_CERT_NUM]);
							if (window.STATE.currentLanguage == 'ru') {
								$('.js-certificate__student-name').html(data.result[newIndex][I_NAME_RU]);
								$('.js-certificate__course-name').text(data.result[newIndex][I_COURSE_RU]);
								$('.js-certificate__page').removeClass('certificate__page_lang_en');
							} else {
								$('.js-certificate__student-name').html(data.result[newIndex][I_NAME_EN]);
								$('.js-certificate__course-name').text(data.result[newIndex][I_COURSE_EN]);
								$('.js-certificate__page').addClass('certificate__page_lang_en');
							}
							$('.js-certificate__theory-hours').text(data.result[newIndex][I_THEORY_H]);
							$('.js-certificate__practice-hours').text(data.result[newIndex][I_PRAC_H]);
							$('.js-certificate__date').text(data.result[newIndex][I_DATE]);

							var newThemeClass = 'certificate__page_theme_' + data.result[newIndex][I_THEME];
							if (!$('.js-certificate__page').hasClass(newThemeClass)) {
								$('.js-certificate__page').removeClass(window.STATE.currentThemeClass);
								window.STATE.currentThemeClass = '';
								if (data.result[newIndex][I_THEME] == THEME_DARK || data.result[newIndex][I_THEME] == THEME_LIGHT) {
									$('.js-certificate__page').addClass(newThemeClass);
									window.STATE.currentThemeClass = newThemeClass;
								}
							}
							generateCanvas();
						}
					});
				}
			});
		});
  </script>
</body>
</html>